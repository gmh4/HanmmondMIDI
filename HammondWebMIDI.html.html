<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Hammond-style Organ (WebMIDI/WebAudio)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root {
    --bg:#0b0e11; --panel:#12171d; --accent:#3aa675; --text:#e8eef5; --muted:#9db0c3;
    --slot:#1b232c; --rail:#1a2028;
  }
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg, #0b0e11 0%, #0e1319 100%);
    color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    display:flex; flex-direction:column; align-items:center;
  }
  header{padding:16px 20px; text-align:center}
  header h1{margin:0; font-size:20px; letter-spacing:.6px}
  header p{margin:6px 0 0; color:var(--muted); font-size:13px}
  #topbar{
    display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
    padding:10px 12px; background:var(--panel); border:1px solid #1f2832; border-radius:10px;
    margin:10px;
  }
  button, select, input[type=range]{
    background:#18212a; color:var(--text); border:1px solid #25303a; border-radius:8px; padding:8px 10px;
    font-size:14px;
  }
  button:hover{background:#1d2833}
  button.primary{background:var(--accent); border-color:#2b7e59; color:#08130e; font-weight:600}
  button.primary:hover{filter:brightness(1.05)}
  .panel{
    background:var(--panel); border:1px solid #1f2832; border-radius:12px; padding:14px;
    margin:10px; width:min(1100px, 96%);
  }
  .flex{display:flex; gap:16px; flex-wrap:wrap; align-items:flex-start}
  .section-title{font-weight:700; font-size:14px; margin-bottom:8px; letter-spacing:.5px; color:#cfe2f3}
  #drawbars{display:flex; gap:14px; align-items:flex-end; justify-content:center}
  .db{
    width:40px; display:flex; flex-direction:column; align-items:center; gap:8px; background: #0f151b;
    padding:10px 8px; border-radius:10px; border:1px solid #1b2430;
  }
  .db label{font-size:11px; color:#cfe2f3; text-align:center; min-height:2.2em}
  .db .value{font-size:13px; width:36px; height:24px; display:grid; place-items:center;
             background:#12202a; border:1px solid #243340; border-radius:6px; color:#a8f0cd; font-weight:700}
  .vslider{ writing-mode: bt-lr; -webkit-appearance: slider-vertical; width:40px; height:220px;
            background:linear-gradient(90deg, #0e151b, #0e151b); border-radius:10px; padding:0 14px;
  }
  .minor{color:var(--muted); font-size:12px}
  .group{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .knob{display:flex; flex-direction:column; gap:6px; align-items:flex-start}
  .knob input[type=range]{width:180px}
  .led{width:10px; height:10px; border-radius:50%; background:#27333e; box-shadow:0 0 0 1px #2a3947 inset}
  .led.on{background:#62ffb1; box-shadow:0 0 12px #62ffb1}
  #log{white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px;
       color:#b5c9da; background:#0c1116; border:1px solid #1b2530; border-radius:8px; padding:10px; max-height:140px; overflow:auto}
  .kbd{background:#11161c; padding:6px 8px; border-radius:6px; border:1px solid #24303a; font-family: ui-monospace, Menlo, monospace; font-size:12px}
  .hints{color:#a9bfce; font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Hammond-style Organ</h1>
  <p>9 drawbars • key click • percussion • vibrato • Leslie (stop/chorale/tremolo/brake) • MIDI controllable</p>
</header>

<div id="topbar">
  <button id="startBtn" class="primary">Start Audio</button>
  <div class="group">
    <label>MIDI In</label>
    <select id="midiIn"></select>
    <span class="hints">Tip: on Chrome/Edge, open via <span class="kbd">http://localhost</span> for WebMIDI.</span>
  </div>
  <div class="group">
    <span>Leslie:</span>
    <button data-leslie="stop">Stop</button>
    <button data-leslie="chorale">Chorale (slow)</button>
    <button data-leslie="tremolo">Tremolo (fast)</button>
    <button data-leslie="brake">Brake</button>
    <span id="leslieLED" class="led" title="Leslie running"></span>
  </div>
</div>

<div class="panel">
  <div class="section-title">Drawbars</div>
  <div id="drawbars"></div>
  <div class="minor" style="margin-top:8px">
    Default CC map: CC20–28 ↔ drawbars (16', 5⅓', 8', 4', 2⅔', 2', 1⅗', 1⅓', 1'). Values 0–127 → notches 0–8.
  </div>
</div>

<div class="panel flex">
  <div style="flex:1 1 320px">
    <div class="section-title">Performance</div>
    <div class="group">
      <div class="knob">
        <label>Expression (CC11)</label>
        <input id="expr" type="range" min="0" max="1" step="0.001" value="0.85">
      </div>
      <div class="knob">
        <label>Overdrive</label>
        <input id="drive" type="range" min="0" max="1" step="0.001" value="0.15">
      </div>
      <div class="knob">
        <label>Key Click</label>
        <input id="click" type="range" min="0" max="1" step="0.001" value="0.25">
      </div>
    </div>

    <div class="section-title" style="margin-top:16px">Vibrato / Chorus</div>
    <div class="group">
      <select id="vibMode">
        <option value="off">Off</option>
        <option value="v1">V1</option>
        <option value="v2">V2</option>
        <option value="v3" selected>V3</option>
        <option value="c1">C1</option>
        <option value="c2">C2</option>
        <option value="c3">C3</option>
      </select>
      <span class="minor">Mod wheel (CC1) cycles modes</span>
    </div>

    <div class="section-title" style="margin-top:16px">Percussion</div>
    <div class="group">
      <label><input type="checkbox" id="percOn" checked> On</label>
      <select id="percHarm">
        <option value="2">2nd harmonic (4')</option>
        <option value="3" selected>3rd harmonic (2⅔')</option>
      </select>
      <select id="percDecay">
        <option value="fast" selected>Fast</option>
        <option value="slow">Slow</option>
      </select>
      <select id="percVol">
        <option value="normal" selected>Normal</option>
        <option value="soft">Soft</option>
      </select>
      <span class="minor">Single-trigger when no other keys held</span>
    </div>
  </div>

  <div style="flex:1 1 280px">
    <div class="section-title">MIDI</div>
    <div class="minor">
      • Notes on any channel. • CC20–28 drawbars, CC11 expression, CC64 Leslie toggle, CC1 vibrato mode. <br/>
      • Map your footswitch to CC64 for slow/fast.
    </div>
    <div id="log" style="margin-top:10px"></div>
  </div>
</div>

<script>
// ======= UTIL =======
const log = (...a)=>{ const el = document.getElementById('log'); el.textContent += a.join(' ') + "\n"; el.scrollTop = el.scrollHeight; };
const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));
const midiToFreq = n => 440 * Math.pow(2, (n - 69) / 12);

// Drawbar footages & harmonic ratios relative to 8' fundamental
const DB_LABELS = ["16'", "5⅓'", "8'", "4'", "2⅔'", "2'", "1⅗'", "1⅓'", "1'"];
const DB_RATIOS = [0.5, 1.5, 1, 2, 3, 4, 5, 6, 8]; // frequency multipliers

// Default drawbar settings (0..8). Classic: 888000000
let drawbarNotches = [8,8,8,0,0,0,0,0,0];

// ======= AUDIO GRAPH =======
let ctx, master, organBus, preDrive, drive, driveCurve;
let vibLFO, vibGainCents, chorusDelayA, chorusDelayB, chorusLFOA,

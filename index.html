<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Hammond-style Organ â€” v14 (Sustain CC64 + Leslie on CC74 only)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body{margin:0;font-family:sans-serif;background:#0b0e11;color:#eee;display:flex;flex-direction:column;align-items:center}
  h1{margin:16px 0}
  #drawbars{display:flex;gap:14px;align-items:flex-end;margin:12px}
  .db{width:60px;display:flex;flex-direction:column;align-items:center}
  .slot{position:relative;width:40px;height:200px;background:#111;border:1px solid #333;border-radius:8px}
  .ticks{position:absolute;left:4px;top:6px;bottom:6px;width:10px;display:flex;flex-direction:column;justify-content:space-between}
  .ticks span{font-size:9px;color:#888}
  input[type=range]{-webkit-appearance:none;appearance:none;position:absolute;top:50%;left:50%;width:200px;transform:translate(-50%,-50%) rotate(-90deg)}
  input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:6px;background:#3aa675}
  input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:6px;background:#3aa675}
  #controls{margin:12px;display:flex;gap:12px}
  button{padding:8px 14px;border-radius:6px;border:1px solid #444;background:#222;color:#eee}
  button.toggle[aria-pressed="true"]{background:#3aa675;color:#000;font-weight:bold}
  #keyboard{display:flex;position:relative;margin:20px}
  .white,.black{border:1px solid #000}
  .white{width:40px;height:160px;background:#fff;z-index:1}
  .black{width:26px;height:100px;background:#000;position:absolute;z-index:2;margin-left:-13px}
  #log{white-space:pre;max-height:120px;overflow-y:auto;background:#111;border:1px solid #333;padding:8px;width:90%;font-size:12px}
</style>
</head>
<body>
<h1>Hammond Organ Simulator v14</h1>

<div id="controls">
  <button id="startBtn" class="primary">Start Audio</button>
  <button id="sustainBtn" class="toggle" aria-pressed="false">Sustain</button>
  <button id="leslieBtn" class="toggle" aria-pressed="false">Leslie Fast</button>
</div>

<div id="drawbars"></div>
<div id="keyboard"></div>

<h3>MIDI Log</h3>
<div id="log"></div>

<script>
const logEl=document.getElementById("log");
function log(msg){logEl.textContent+=msg+"\\n";logEl.scrollTop=logEl.scrollHeight;}

const drawbarsEl=document.getElementById("drawbars");
for(let i=1;i<=9;i++){
  let wrap=document.createElement("div");wrap.className="db";
  let slot=document.createElement("div");slot.className="slot";
  let ticks=document.createElement("div");ticks.className="ticks";
  for(let j=8;j>=1;j--){let s=document.createElement("span");s.textContent=j;ticks.appendChild(s);}
  let slider=document.createElement("input");slider.type="range";slider.min=0;slider.max=8;slider.value=0;slider.className="vslider";
  slot.appendChild(ticks);slot.appendChild(slider);wrap.appendChild(slot);
  let label=document.createElement("label");label.textContent="DB"+i;wrap.appendChild(label);
  drawbarsEl.appendChild(wrap);
}

// on-screen keyboard
const kb=document.getElementById("keyboard");
let whiteCount=14;
for(let i=0;i<whiteCount;i++){let w=document.createElement("div");w.className="white";w.dataset.note=i;kb.appendChild(w);}
let blackOffsets=[0,1,3,4,5,7,8,10,11,12];
for(let i=0;i<whiteCount-1;i++){if(![2,6,9,13].includes(i)){let b=document.createElement("div");b.className="black";b.style.left=(40*(i+1))+"px";b.dataset.note="b"+i;kb.appendChild(b);}}

let audioCtx,oscList={},sustain=false,heldNotes=new Set(),sustainHeld=new Set();
let leslieFast=false;

function noteOn(note){
  if(!audioCtx) return;
  if(oscList[note]) return;
  let osc=audioCtx.createOscillator();osc.type="sine";osc.frequency.value=220*Math.pow(2,note/12);
  let gain=audioCtx.createGain();gain.gain.value=0.15;
  osc.connect(gain).connect(audioCtx.destination);osc.start();
  oscList[note]={osc,gain};
}
function noteOff(note){
  if(sustain){sustainHeld.add(note);return;}
  if(oscList[note]){oscList[note].osc.stop();oscList[note].osc.disconnect();oscList[note].gain.disconnect();delete oscList[note];}
}
document.querySelectorAll(".white,.black").forEach(k=>{
  k.addEventListener("mousedown",()=>noteOn(k.dataset.note));
  k.addEventListener("mouseup",()=>noteOff(k.dataset.note));
});

document.getElementById("startBtn").onclick=()=>{audioCtx=new (window.AudioContext||window.webkitAudioContext)();log("Audio started")};
document.getElementById("sustainBtn").onclick=()=>{sustain=!sustain;document.getElementById("sustainBtn").setAttribute("aria-pressed",sustain)};
document.getElementById("leslieBtn").onclick=()=>{leslieFast=!leslieFast;document.getElementById("leslieBtn").setAttribute("aria-pressed",leslieFast)};

// MIDI
if(navigator.requestMIDIAccess){
  navigator.requestMIDIAccess().then(midi=>{
    for(let input of midi.inputs.values()){input.onmidimessage=onMIDI;}
  });
}
function onMIDI(msg){
  let [cmd,note,vel]=msg.data;
  log("MIDI: "+cmd+" "+note+" "+vel);
  if((cmd&0xf0)==0x90 && vel>0){noteOn(note);}
  else if((cmd&0xf0)==0x80 || ((cmd&0xf0)==0x90 && vel==0)){noteOff(note);}
  else if((cmd&0xf0)==0xB0){
    if(note==64){ // sustain pedal
      sustain=(vel>63);
      document.getElementById("sustainBtn").setAttribute("aria-pressed",sustain);
      if(!sustain){for(let n of sustainHeld)noteOff(n);sustainHeld.clear();}
    }
    if(note==74){ // joystick horizontal
      let prev=leslieFast;
      leslieFast=(vel>=64);
      if(leslieFast!==prev){document.getElementById("leslieBtn").setAttribute("aria-pressed",leslieFast);}
    }
  }
}
</script>
</body>
</html>
